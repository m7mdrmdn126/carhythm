{% extends "base/admin_base.html" %}

{% block title %}Manage Pages - Career DNA Admin{% endblock %}

{% block content %}
<div class="page-management">
    <div class="page-header">
        <h2>Manage Pages</h2>
        <button class="btn btn-primary" onclick="showCreatePageModal()">Add New Page</button>
    </div>
    
    <div class="pages-list">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>Order</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Questions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for page in pages %}
                <tr data-page-id="{{ page.id }}">
                    <td>
                        <span class="drag-handle" title="Drag to reorder">
                            <i class="fas fa-grip-vertical"></i>
                        </span>
                    </td>
                    <td>{{ page.order_index }}</td>
                    <td>{{ page.title }}</td>
                    <td>{{ page.description or "No description" }}</td>
                    <td>
                        <span class="status {{ 'active' if page.is_active else 'inactive' }}">
                            {{ "Active" if page.is_active else "Inactive" }}
                        </span>
                    </td>
                    <td>{{ page.questions|length }} questions</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editPage({{ page.id }}, '{{ page.title }}', '{{ page.description or '' }}', {{ page.order_index }}, {{ page.is_active|lower }}, '{{ page.module_name or '' }}', '{{ page.module_emoji or '' }}', {{ page.chapter_number or 'null' }}, {{ page.estimated_minutes or 'null' }}, '{{ page.completion_message or '' }}')">Edit</button>
                        <a href="/admin/questions?page_id={{ page.id }}" class="btn btn-sm btn-secondary">Questions</a>
                        <form method="post" action="/admin/pages/{{ page.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure?')">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">No pages created yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Page Modal -->
<div id="createPageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Page</h3>
            <button class="close" onclick="hideCreatePageModal()">&times;</button>
        </div>
        <form method="post" action="/admin/pages">
            <div class="modal-body">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="order_index">Order</label>
                    <input type="number" id="order_index" name="order_index" value="{{ (pages|length) }}">
                </div>
                
                <hr style="margin: 24px 0;">
                <h4 style="color: var(--primary-aubergine); margin-bottom: 16px;">ðŸ“– Story Mode Settings (Optional)</h4>
                
                <div class="form-group">
                    <label for="module_name">Module Name</label>
                    <input type="text" id="module_name" name="module_name" placeholder="e.g., RIASEC, Big Five, Work Rhythm">
                    <small style="color: var(--text-light);">Groups pages into chapters for Story Mode</small>
                </div>
                
                <div class="form-group">
                    <label for="module_emoji">Module Emoji</label>
                    <input type="text" id="module_emoji" name="module_emoji" placeholder="e.g., ðŸŽ¯, ðŸ§ , âš¡" maxlength="10">
                    <small style="color: var(--text-light);">Visual icon for this module</small>
                </div>
                
                <div class="form-group">
                    <label for="chapter_number">Chapter Number</label>
                    <input type="number" id="chapter_number" name="chapter_number" min="0" placeholder="e.g., 1, 2, 3">
                    <small style="color: var(--text-light);">For ordering modules in Story Mode</small>
                </div>
                
                <div class="form-group">
                    <label for="estimated_minutes">Estimated Minutes</label>
                    <input type="number" id="estimated_minutes" name="estimated_minutes" min="1" placeholder="e.g., 5">
                    <small style="color: var(--text-light);">How long this page takes to complete</small>
                </div>
                
                <div class="form-group">
                    <label for="completion_message">Completion Message</label>
                    <textarea id="completion_message" name="completion_message" rows="2" placeholder="Great job! You've completed this section."></textarea>
                    <small style="color: var(--text-light);">Message shown after completing this page</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCreatePageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Page</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Page Modal -->
<div id="editPageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Page</h3>
            <button class="close" onclick="hideEditPageModal()">&times;</button>
        </div>
        <form method="post" id="editPageForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit_title">Title</label>
                    <input type="text" id="edit_title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit_description">Description</label>
                    <textarea id="edit_description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit_order_index">Order</label>
                    <input type="number" id="edit_order_index" name="order_index" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit_is_active" name="is_active" value="true">
                        Active
                    </label>
                </div>
                
                <hr style="margin: 24px 0;">
                <h4 style="color: var(--primary-aubergine); margin-bottom: 16px;">ðŸ“– Story Mode Settings (Optional)</h4>
                
                <div class="form-group">
                    <label for="edit_module_name">Module Name</label>
                    <input type="text" id="edit_module_name" name="module_name" placeholder="e.g., RIASEC, Big Five">
                </div>
                
                <div class="form-group">
                    <label for="edit_module_emoji">Module Emoji</label>
                    <input type="text" id="edit_module_emoji" name="module_emoji" placeholder="e.g., ðŸŽ¯" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label for="edit_chapter_number">Chapter Number</label>
                    <input type="number" id="edit_chapter_number" name="chapter_number" min="0">
                </div>
                
                <div class="form-group">
                    <label for="edit_estimated_minutes">Estimated Minutes</label>
                    <input type="number" id="edit_estimated_minutes" name="estimated_minutes" min="1">
                </div>
                
                <div class="form-group">
                    <label for="edit_completion_message">Completion Message</label>
                    <textarea id="edit_completion_message" name="completion_message" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideEditPageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Page</button>
            </div>
        </form>
    </div>
</div>

<script>
function showCreatePageModal() {
    document.getElementById('createPageModal').style.display = 'flex';
}

function hideCreatePageModal() {
    document.getElementById('createPageModal').style.display = 'none';
}

function editPage(id, title, description, orderIndex, isActive) {
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_order_index').value = orderIndex;
    document.getElementById('edit_is_active').checked = isActive;
    
    // Fetch page data to populate Story Mode fields
    fetch(`/admin/pages`)
        .then(() => {
            // Story Mode fields will be empty for now, admin can fill them
            document.getElementById('edit_module_name').value = '';
            document.getElementById('edit_module_emoji').value = '';
            document.getElementById('edit_chapter_number').value = '';
            document.getElementById('edit_estimated_minutes').value = '';
            document.getElementById('edit_completion_message').value = '';
        });
    
    document.getElementById('editPageForm').action = `/admin/pages/${id}/edit`;
    document.getElementById('editPageModal').style.display = 'flex';
}

function hideEditPageModal() {
    document.getElementById('editPageModal').style.display = 'none';
}
</script>

<!-- SortableJS for drag-and-drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
<script>
// Initialize drag-and-drop sorting
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.querySelector('.pages-list tbody');
    if (tableBody) {
        new Sortable(tableBody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                // Get new order
                const rows = tableBody.querySelectorAll('tr');
                const pageOrder = Array.from(rows).map(row => row.dataset.pageId);
                
                // Send to backend
                fetch('/admin/pages/update-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ order: pageOrder })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Page order updated successfully', 'success');
                    } else {
                        showToast(data.message || 'Failed to update order', 'error');
                        setTimeout(() => window.location.reload(), 1000);
                    }
                })
                .catch(error => {
                    showToast('Error updating page order', 'error');
                    console.error('Error:', error);
                    setTimeout(() => window.location.reload(), 1000);
                });
            }
        });
    }
});

function updatePageOrder(pageId, newOrder) {
    // Deprecated - now using batch update above
}
</script>

<style>
.drag-handle {
    cursor: grab;
    color: var(--text-light);
    padding: 4px 8px;
}

.drag-handle:active {
    cursor: grabbing;
}

.sortable-ghost {
    opacity: 0.4;
    background: var(--accent-yellow);
}
</style>
{% endblock %}