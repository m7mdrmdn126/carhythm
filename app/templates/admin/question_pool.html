{% extends "base/admin_base.html" %}

{% block title %}Question Pool - Career DNA Admin{% endblock %}

{% block content %}
<div class="question-pool-management">
    <div class="page-header">
        <h2>Question Pool Management</h2>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showCreateQuestionModal()">Add Question</button>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('csvDropdown')">
                    CSV Operations
                </button>
                <div id="csvDropdown" class="dropdown-menu">
                    <a href="/admin/csv-templates/essay" class="dropdown-item">Download Essay Template</a>
                    <a href="/admin/csv-templates/slider" class="dropdown-item">Download Slider Template</a>
                    <a href="/admin/csv-templates/mcq" class="dropdown-item">Download MCQ Template</a>
                    <a href="/admin/csv-templates/ordering" class="dropdown-item">Download Ordering Template</a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="showImportModal()">Import Questions</button>
                    <button class="dropdown-item" onclick="showExportModal()">Export Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="statistics-cards">
        <div class="stat-card">
            <h3>Total Questions</h3>
            <div class="stat-number">{{ stats.total_questions }}</div>
        </div>
        <div class="stat-card">
            <h3>By Type</h3>
            <div class="stat-details">
                {% for type, count in stats.by_type.items() %}
                <div class="stat-item">{{ type.title() }}: {{ count }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="stat-card">
            <h3>Most Used</h3>
            <div class="stat-details">
                {% for item in stats.most_used[:3] %}
                <div class="stat-item">{{ item.title[:30] }}...: {{ item.usage_count }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-panel">
        <form method="get" class="filters-form">
            <div class="filter-group">
                <select name="category_id" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {{ "selected" if current_filters.category_id == category.id }}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <select name="question_type" onchange="this.form.submit()">
                    <option value="">All Types</option>
                    {% for type in question_types %}
                    <option value="{{ type }}" {{ "selected" if current_filters.question_type == type }}>
                        {{ type.title() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <input type="text" name="search" placeholder="Search questions..." 
                       value="{{ current_filters.search or '' }}">
            </div>
            <div class="filter-group">
                <button type="submit" class="btn btn-secondary">Filter</button>
                <a href="/admin/question-pool" class="btn btn-outline">Clear</a>
            </div>
        </form>
    </div>

    <!-- Questions List -->
    <div class="questions-list">
        <table class="admin-table">
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Usage</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for question in questions %}
                <tr>
                    <td><input type="checkbox" name="question_ids" value="{{ question.id }}" class="question-checkbox"></td>
                    <td class="question-title">
                        <strong>{{ question.title }}</strong>
                        <div class="question-preview">{{ question.question_text[:100] }}{% if question.question_text|length > 100 %}...{% endif %}</div>
                    </td>
                    <td>
                        <span class="question-type {{ question.question_type }}">
                            {{ question.question_type.title() }}
                        </span>
                    </td>
                    <td>
                        {% if question.category %}
                        <span class="category-badge" style="background-color: {{ question.category.color }}20; color: {{ question.category.color }};">
                            {{ question.category.name }}
                        </span>
                        {% else %}
                        <span class="no-category">No category</span>
                        {% endif %}
                    </td>
                    <td class="usage-count">{{ question.usage_count }}</td>
                    <td class="created-date">{{ question.created_at.strftime('%Y-%m-%d') }}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editQuestion({{ question.id }})">Edit</button>
                        <button class="btn btn-sm btn-info" onclick="viewUsage({{ question.id }})">Usage</button>
                        <form method="post" action="/admin/question-pool/{{ question.id }}/delete" style="display: inline;" 
                              onsubmit="return confirm('Are you sure? This will also remove all assignments.')">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center">No questions found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Question Modal -->
<div id="createQuestionModal" class="modal" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h3>Create New Question</h3>
            <button class="close" onclick="hideCreateQuestionModal()">&times;</button>
        </div>
        <form method="post" action="/admin/question-pool/create" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label for="title">Question Title</label>
                    <input type="text" id="title" name="title" required placeholder="Brief descriptive title">
                </div>
                
                <div class="form-group">
                    <label for="question_text">Question Text</label>
                    <textarea id="question_text" name="question_text" rows="4" required 
                              placeholder="The actual question text shown to students"></textarea>
                </div>
                
                <div class="form-row two-columns">
                    <div class="form-group">
                        <label for="question_type">Question Type</label>
                        <select id="question_type" name="question_type" required onchange="toggleQuestionTypeFields()">
                            <option value="">Select type...</option>
                            <option value="essay">Essay</option>
                            <option value="slider">Slider</option>
                            <option value="mcq">Multiple Choice</option>
                            <option value="ordering">Ordering</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category_id">Category</label>
                        <select id="category_id" name="category_id">
                            <option value="">No category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Type-specific fields -->
                <div id="essayFields" class="question-type-fields" style="display: none;">
                    <div class="form-group">
                        <label for="essay_char_limit">Character Limit (optional)</label>
                        <input type="number" id="essay_char_limit" name="essay_char_limit" 
                               min="50" max="5000" placeholder="e.g., 500">
                    </div>
                </div>
                
                <div id="sliderFields" class="question-type-fields" style="display: none;">
                    <div class="form-row two-columns">
                        <div class="form-group">
                            <label for="slider_min_label">Minimum Label (0%)</label>
                            <input type="text" id="slider_min_label" name="slider_min_label" 
                                   placeholder="e.g., Strongly Disagree">
                        </div>
                        <div class="form-group">
                            <label for="slider_max_label">Maximum Label (100%)</label>
                            <input type="text" id="slider_max_label" name="slider_max_label" 
                                   placeholder="e.g., Strongly Agree">
                        </div>
                    </div>
                </div>
                
                <div id="mcqFields" class="question-type-fields" style="display: none;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="allow_multiple_selection" name="allow_multiple_selection">
                            Allow Multiple Selection
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Answer Options</label>
                        <div id="mcqOptionsContainer">
                            <div class="mcq-option">
                                <input type="text" name="mcq_option" placeholder="Option 1" required>
                                <input type="checkbox" name="mcq_correct" value="0" title="Mark as correct">
                                <button type="button" onclick="removeMcqOption(this)" class="btn btn-sm btn-danger">×</button>
                            </div>
                            <div class="mcq-option">
                                <input type="text" name="mcq_option" placeholder="Option 2" required>
                                <input type="checkbox" name="mcq_correct" value="1" title="Mark as correct">
                                <button type="button" onclick="removeMcqOption(this)" class="btn btn-sm btn-danger">×</button>
                            </div>
                        </div>
                        <button type="button" onclick="addMcqOption()" class="btn btn-sm btn-secondary">Add Option</button>
                    </div>
                </div>
                
                <div id="orderingFields" class="question-type-fields" style="display: none;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="randomize_order" name="randomize_order" checked>
                            Randomize Initial Order for Students
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Items to Order</label>
                        <div id="orderingOptionsContainer">
                            <div class="ordering-option">
                                <input type="text" name="ordering_option" placeholder="Item 1" required>
                                <button type="button" onclick="removeOrderingOption(this)" class="btn btn-sm btn-danger">×</button>
                            </div>
                            <div class="ordering-option">
                                <input type="text" name="ordering_option" placeholder="Item 2" required>
                                <button type="button" onclick="removeOrderingOption(this)" class="btn btn-sm btn-danger">×</button>
                            </div>
                        </div>
                        <button type="button" onclick="addOrderingOption()" class="btn btn-sm btn-secondary">Add Item</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="is_required" checked>
                        Required Question
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCreateQuestionModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Question</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Import Questions from CSV</h3>
            <button class="close" onclick="hideImportModal()">&times;</button>
        </div>
        <form id="importForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label for="import_question_type">Question Type</label>
                    <select id="import_question_type" name="question_type" required>
                        <option value="">Select type...</option>
                        <option value="essay">Essay</option>
                        <option value="slider">Slider</option>
                        <option value="mcq">Multiple Choice</option>
                        <option value="ordering">Ordering</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="csv_file">CSV File</label>
                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                    <small>Download the template first to see the required format</small>
                </div>
                <div id="import_progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="progress-text">Importing questions...</div>
                </div>
                <div id="import_result" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideImportModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Import Questions</button>
            </div>
        </form>
    </div>
</div>

<script>
// Question Pool Management JavaScript
function showCreateQuestionModal() {
    document.getElementById('createQuestionModal').style.display = 'block';
}

function hideCreateQuestionModal() {
    document.getElementById('createQuestionModal').style.display = 'none';
}

function toggleQuestionTypeFields() {
    const type = document.getElementById('question_type').value;
    const essayFields = document.getElementById('essayFields');
    const sliderFields = document.getElementById('sliderFields');
    const mcqFields = document.getElementById('mcqFields');
    const orderingFields = document.getElementById('orderingFields');
    
    // Hide all fields first
    essayFields.style.display = 'none';
    sliderFields.style.display = 'none';
    mcqFields.style.display = 'none';
    orderingFields.style.display = 'none';
    
    // Show relevant fields
    if (type === 'essay') {
        essayFields.style.display = 'block';
    } else if (type === 'slider') {
        sliderFields.style.display = 'block';
    } else if (type === 'mcq') {
        mcqFields.style.display = 'block';
    } else if (type === 'ordering') {
        orderingFields.style.display = 'block';
    }
}

function addMcqOption() {
    const container = document.getElementById('mcqOptionsContainer');
    const optionCount = container.children.length;
    const optionDiv = document.createElement('div');
    optionDiv.className = 'mcq-option';
    optionDiv.innerHTML = `
        <input type="text" name="mcq_option" placeholder="Option ${optionCount + 1}" required>
        <input type="checkbox" name="mcq_correct" value="${optionCount}" title="Mark as correct">
        <button type="button" onclick="removeMcqOption(this)" class="btn btn-sm btn-danger">×</button>
    `;
    container.appendChild(optionDiv);
}

function removeMcqOption(button) {
    const container = document.getElementById('mcqOptionsContainer');
    if (container.children.length > 2) {
        button.parentElement.remove();
        // Update checkbox values
        Array.from(container.children).forEach((div, index) => {
            const checkbox = div.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.value = index;
        });
    } else {
        alert('At least 2 options are required for MCQ questions.');
    }
}

function addOrderingOption() {
    const container = document.getElementById('orderingOptionsContainer');
    const optionCount = container.children.length + 1;
    const optionDiv = document.createElement('div');
    optionDiv.className = 'ordering-option';
    optionDiv.innerHTML = `
        <input type="text" name="ordering_option" placeholder="Item ${optionCount}" required>
        <button type="button" onclick="removeOrderingOption(this)" class="btn btn-sm btn-danger">×</button>
    `;
    container.appendChild(optionDiv);
}

function removeOrderingOption(button) {
    const container = document.getElementById('orderingOptionsContainer');
    if (container.children.length > 2) {
        button.parentElement.remove();
    } else {
        alert('At least 2 items are required for ordering questions.');
    }
}

function toggleAllCheckboxes(masterCheckbox) {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
    });
}

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// CSV Import functionality
function showImportModal() {
    document.getElementById('importModal').style.display = 'block';
}

function hideImportModal() {
    document.getElementById('importModal').style.display = 'none';
    document.getElementById('import_result').style.display = 'none';
    document.getElementById('import_progress').style.display = 'none';
}

document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const questionType = formData.get('question_type');
    
    // Show progress
    document.getElementById('import_progress').style.display = 'block';
    document.getElementById('import_result').style.display = 'none';
    
    try {
        const response = await fetch(`/admin/csv-import/${questionType}`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        // Hide progress
        document.getElementById('import_progress').style.display = 'none';
        
        // Show result
        const resultDiv = document.getElementById('import_result');
        resultDiv.style.display = 'block';
        
        if (result.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Import completed!</strong><br>
                    Total rows: ${result.total_rows}<br>
                    Successful: ${result.successful_imports}<br>
                    Failed: ${result.failed_imports}
                </div>
            `;
            
            if (result.errors && result.errors.length > 0) {
                resultDiv.innerHTML += '<div class="alert alert-warning"><strong>Errors:</strong><ul>';
                result.errors.forEach(error => {
                    resultDiv.innerHTML += `<li>Row ${error.row}: ${error.error}</li>`;
                });
                resultDiv.innerHTML += '</ul></div>';
            }
            
            // Refresh page after a delay
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">Import failed: ${result.error}</div>`;
        }
        
    } catch (error) {
        document.getElementById('import_progress').style.display = 'none';
        document.getElementById('import_result').innerHTML = 
            `<div class="alert alert-error">Error: ${error.message}</div>`;
        document.getElementById('import_result').style.display = 'block';
    }
});

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.matches('.dropdown-toggle')) {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});
</script>

<style>
.question-pool-management {
    max-width: 1400px;
    margin: 0 auto;
}

.statistics-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    color: var(--primary-color);
}

.stat-details {
    font-size: 14px;
}

.stat-item {
    margin-bottom: 5px;
    color: #666;
}

.filters-panel {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filters-form {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.question-title {
    max-width: 300px;
}

.question-preview {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.category-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.no-category {
    color: #999;
    font-style: italic;
}

.usage-count {
    text-align: center;
    font-weight: bold;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-menu {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    z-index: 1000;
    border-radius: 4px;
    top: 100%;
    right: 0;
}

.dropdown-item {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
}

.dropdown-item:hover {
    background-color: #f1f1f1;
}

.dropdown-divider {
    height: 1px;
    background-color: #e9ecef;
    margin: 8px 0;
}

.modal-content.large {
    max-width: 800px;
    width: 90%;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color);
    width: 0%;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0%, 100% { width: 0%; }
    50% { width: 100%; }
}

.alert {
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-error {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}
</style>
{% endblock %}